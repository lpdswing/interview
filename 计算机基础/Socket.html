<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.51">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="shortcut icon" href="favicon.ico"><script src="/_vercel/insights/script.js" defer></script><title>Socket | Interview Notes</title><meta name="description" content="技术面试基础知识, 算法, 网络, 操作系统, 数据库, Python">
    <link rel="modulepreload" href="/interview/assets/app.5177f3e3.js"><link rel="modulepreload" href="/interview/assets/Socket.html.0198ea5f.js"><link rel="modulepreload" href="/interview/assets/Socket.html.6a68f31e.js"><link rel="prefetch" href="/interview/assets/index.html.c6a3770d.js"><link rel="prefetch" href="/interview/assets/MySQL.html.88da230e.js"><link rel="prefetch" href="/interview/assets/Redis.html.7c2c1bae.js"><link rel="prefetch" href="/interview/assets/SQL练习.html.640f5cbd.js"><link rel="prefetch" href="/interview/assets/SQL语法.html.231e1acc.js"><link rel="prefetch" href="/interview/assets/数据库系统原理.html.5cce4ddd.js"><link rel="prefetch" href="/interview/assets/分布式.html.b74a3bbe.js"><link rel="prefetch" href="/interview/assets/攻击技术.html.61d396be.js"><link rel="prefetch" href="/interview/assets/消息队列.html.bc53ed40.js"><link rel="prefetch" href="/interview/assets/系统设计基础.html.1d533f83.js"><link rel="prefetch" href="/interview/assets/缓存.html.0f10010a.js"><link rel="prefetch" href="/interview/assets/集群.html.64c1f821.js"><link rel="prefetch" href="/interview/assets/Docker.html.63211cb8.js"><link rel="prefetch" href="/interview/assets/Git.html.70b7ded5.js"><link rel="prefetch" href="/interview/assets/正则表达式.html.da9ff3be.js"><link rel="prefetch" href="/interview/assets/HTTP.html.8c94c478.js"><link rel="prefetch" href="/interview/assets/Linux.html.6e8630a8.js"><link rel="prefetch" href="/interview/assets/面向对象思想.html.8fa5a16b.js"><link rel="prefetch" href="/interview/assets/index.html.9cb29137.js"><link rel="prefetch" href="/interview/assets/算法 - 其它.html.b2e7afe9.js"><link rel="prefetch" href="/interview/assets/算法 - 并查集.html.ddd38526.js"><link rel="prefetch" href="/interview/assets/算法 - 排序.html.fb8ec64e.js"><link rel="prefetch" href="/interview/assets/算法 - 栈和队列.html.04aadcda.js"><link rel="prefetch" href="/interview/assets/算法 - 符号表.html.a476e4f6.js"><link rel="prefetch" href="/interview/assets/算法 - 算法分析.html.b33608ae.js"><link rel="prefetch" href="/interview/assets/index.html.50572729.js"><link rel="prefetch" href="/interview/assets/Socket.html.8b3bbe23.js"><link rel="prefetch" href="/interview/assets/计算机操作系统 - 内存管理.html.b793672f.js"><link rel="prefetch" href="/interview/assets/计算机操作系统 - 概述.html.aa2e3f1d.js"><link rel="prefetch" href="/interview/assets/计算机操作系统 - 死锁.html.f9c443a1.js"><link rel="prefetch" href="/interview/assets/计算机操作系统 - 设备管理.html.6b42287e.js"><link rel="prefetch" href="/interview/assets/计算机操作系统 - 进程管理.html.1e229faf.js"><link rel="prefetch" href="/interview/assets/计算机操作系统 - 链接.html.f5ba4246.js"><link rel="prefetch" href="/interview/assets/index.html.87520f20.js"><link rel="prefetch" href="/interview/assets/计算机网络 - 传输层.html.febc3117.js"><link rel="prefetch" href="/interview/assets/计算机网络 - 应用层.html.251c6ef7.js"><link rel="prefetch" href="/interview/assets/计算机网络 - 概述.html.a4ac3363.js"><link rel="prefetch" href="/interview/assets/计算机网络 - 物理层.html.814a40ec.js"><link rel="prefetch" href="/interview/assets/计算机网络 - 网络层.html.ac092f4f.js"><link rel="prefetch" href="/interview/assets/计算机网络 - 链路层.html.08180edc.js"><link rel="prefetch" href="/interview/assets/index.html.b928470d.js"><link rel="prefetch" href="/interview/assets/设计模式  - 单例.html.0949fc12.js"><link rel="prefetch" href="/interview/assets/设计模式 - 中介者.html.edda411a.js"><link rel="prefetch" href="/interview/assets/设计模式 - 享元.html.bcc0883f.js"><link rel="prefetch" href="/interview/assets/设计模式 - 代理.html.d0f3ef9b.js"><link rel="prefetch" href="/interview/assets/设计模式 - 原型模式.html.71cf8127.js"><link rel="prefetch" href="/interview/assets/设计模式 - 命令.html.d762cafd.js"><link rel="prefetch" href="/interview/assets/设计模式 - 备忘录.html.8bb0266e.js"><link rel="prefetch" href="/interview/assets/设计模式 - 外观.html.ec75bec1.js"><link rel="prefetch" href="/interview/assets/设计模式 - 工厂方法.html.98244e69.js"><link rel="prefetch" href="/interview/assets/设计模式 - 抽象工厂.html.dbc733c6.js"><link rel="prefetch" href="/interview/assets/设计模式 - 桥接.html.c8435d55.js"><link rel="prefetch" href="/interview/assets/设计模式 - 模板方法.html.04ae9ec2.js"><link rel="prefetch" href="/interview/assets/设计模式 - 状态.html.4c6c67bd.js"><link rel="prefetch" href="/interview/assets/设计模式 - 生成器.html.69d592d5.js"><link rel="prefetch" href="/interview/assets/设计模式 - 空对象.html.e7fc13a8.js"><link rel="prefetch" href="/interview/assets/设计模式 - 策略.html.05e5f519.js"><link rel="prefetch" href="/interview/assets/设计模式 - 简单工厂.html.72e01f01.js"><link rel="prefetch" href="/interview/assets/设计模式 - 组合.html.8fea7e91.js"><link rel="prefetch" href="/interview/assets/设计模式 - 装饰.html.34050f40.js"><link rel="prefetch" href="/interview/assets/设计模式 - 观察者.html.80d625ec.js"><link rel="prefetch" href="/interview/assets/设计模式 - 解释器.html.16e0a3db.js"><link rel="prefetch" href="/interview/assets/设计模式 - 访问者.html.c572650e.js"><link rel="prefetch" href="/interview/assets/设计模式 - 责任链.html.04211247.js"><link rel="prefetch" href="/interview/assets/设计模式 - 迭代器.html.2102c01c.js"><link rel="prefetch" href="/interview/assets/设计模式 - 适配器.html.a9f03bd1.js"><link rel="prefetch" href="/interview/assets/404.html.c3e557d0.js"><link rel="prefetch" href="/interview/assets/index.html.4611d71f.js"><link rel="prefetch" href="/interview/assets/MySQL.html.b309a05c.js"><link rel="prefetch" href="/interview/assets/Redis.html.1bbe3c7d.js"><link rel="prefetch" href="/interview/assets/SQL练习.html.89f88484.js"><link rel="prefetch" href="/interview/assets/SQL语法.html.815e8e54.js"><link rel="prefetch" href="/interview/assets/数据库系统原理.html.e73fd678.js"><link rel="prefetch" href="/interview/assets/分布式.html.07947da8.js"><link rel="prefetch" href="/interview/assets/攻击技术.html.7fec0806.js"><link rel="prefetch" href="/interview/assets/消息队列.html.c93b7ec0.js"><link rel="prefetch" href="/interview/assets/系统设计基础.html.3ecb26c5.js"><link rel="prefetch" href="/interview/assets/缓存.html.be79ea9a.js"><link rel="prefetch" href="/interview/assets/集群.html.56d8ce1c.js"><link rel="prefetch" href="/interview/assets/Docker.html.d6eb2a5b.js"><link rel="prefetch" href="/interview/assets/Git.html.8361dc78.js"><link rel="prefetch" href="/interview/assets/正则表达式.html.b5078dee.js"><link rel="prefetch" href="/interview/assets/HTTP.html.a464df6b.js"><link rel="prefetch" href="/interview/assets/Linux.html.4a90a6aa.js"><link rel="prefetch" href="/interview/assets/面向对象思想.html.6687ac7f.js"><link rel="prefetch" href="/interview/assets/index.html.3d66e6cc.js"><link rel="prefetch" href="/interview/assets/算法 - 其它.html.cf895db7.js"><link rel="prefetch" href="/interview/assets/算法 - 并查集.html.febff1c7.js"><link rel="prefetch" href="/interview/assets/算法 - 排序.html.d2ff4878.js"><link rel="prefetch" href="/interview/assets/算法 - 栈和队列.html.6f514858.js"><link rel="prefetch" href="/interview/assets/算法 - 符号表.html.86d8e1a8.js"><link rel="prefetch" href="/interview/assets/算法 - 算法分析.html.676cdeec.js"><link rel="prefetch" href="/interview/assets/index.html.6999fb26.js"><link rel="prefetch" href="/interview/assets/Socket.html.ae9d6c79.js"><link rel="prefetch" href="/interview/assets/计算机操作系统 - 内存管理.html.1d2f068f.js"><link rel="prefetch" href="/interview/assets/计算机操作系统 - 概述.html.1cc7be78.js"><link rel="prefetch" href="/interview/assets/计算机操作系统 - 死锁.html.132da1b7.js"><link rel="prefetch" href="/interview/assets/计算机操作系统 - 设备管理.html.24140789.js"><link rel="prefetch" href="/interview/assets/计算机操作系统 - 进程管理.html.2f6c3af5.js"><link rel="prefetch" href="/interview/assets/计算机操作系统 - 链接.html.89badc94.js"><link rel="prefetch" href="/interview/assets/index.html.5b0dc4cd.js"><link rel="prefetch" href="/interview/assets/计算机网络 - 传输层.html.a667d652.js"><link rel="prefetch" href="/interview/assets/计算机网络 - 应用层.html.6d5317f0.js"><link rel="prefetch" href="/interview/assets/计算机网络 - 概述.html.e57333a3.js"><link rel="prefetch" href="/interview/assets/计算机网络 - 物理层.html.248521df.js"><link rel="prefetch" href="/interview/assets/计算机网络 - 网络层.html.9f6d1bde.js"><link rel="prefetch" href="/interview/assets/计算机网络 - 链路层.html.0ca1cc59.js"><link rel="prefetch" href="/interview/assets/index.html.6ef2a33e.js"><link rel="prefetch" href="/interview/assets/设计模式  - 单例.html.a42561dc.js"><link rel="prefetch" href="/interview/assets/设计模式 - 中介者.html.3916dff4.js"><link rel="prefetch" href="/interview/assets/设计模式 - 享元.html.4df094f3.js"><link rel="prefetch" href="/interview/assets/设计模式 - 代理.html.df9c820d.js"><link rel="prefetch" href="/interview/assets/设计模式 - 原型模式.html.75546b9d.js"><link rel="prefetch" href="/interview/assets/设计模式 - 命令.html.a0cc4140.js"><link rel="prefetch" href="/interview/assets/设计模式 - 备忘录.html.9ff16651.js"><link rel="prefetch" href="/interview/assets/设计模式 - 外观.html.2f0f8f61.js"><link rel="prefetch" href="/interview/assets/设计模式 - 工厂方法.html.3fde6c4a.js"><link rel="prefetch" href="/interview/assets/设计模式 - 抽象工厂.html.e13fb6b3.js"><link rel="prefetch" href="/interview/assets/设计模式 - 桥接.html.3a46b2ba.js"><link rel="prefetch" href="/interview/assets/设计模式 - 模板方法.html.4a29737a.js"><link rel="prefetch" href="/interview/assets/设计模式 - 状态.html.92345325.js"><link rel="prefetch" href="/interview/assets/设计模式 - 生成器.html.12f98b4c.js"><link rel="prefetch" href="/interview/assets/设计模式 - 空对象.html.0233b488.js"><link rel="prefetch" href="/interview/assets/设计模式 - 策略.html.83a8d8b0.js"><link rel="prefetch" href="/interview/assets/设计模式 - 简单工厂.html.b0693859.js"><link rel="prefetch" href="/interview/assets/设计模式 - 组合.html.0403d9b1.js"><link rel="prefetch" href="/interview/assets/设计模式 - 装饰.html.c56bceef.js"><link rel="prefetch" href="/interview/assets/设计模式 - 观察者.html.dc2344a6.js"><link rel="prefetch" href="/interview/assets/设计模式 - 解释器.html.a631829e.js"><link rel="prefetch" href="/interview/assets/设计模式 - 访问者.html.7a1f8194.js"><link rel="prefetch" href="/interview/assets/设计模式 - 责任链.html.c06d8a53.js"><link rel="prefetch" href="/interview/assets/设计模式 - 迭代器.html.33fd0ba9.js"><link rel="prefetch" href="/interview/assets/设计模式 - 适配器.html.8823a1c3.js"><link rel="prefetch" href="/interview/assets/404.html.aa4908c9.js">
    <link rel="stylesheet" href="/interview/assets/style.a05147f3.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/interview/" class=""><img class="logo" src="/interview/favicon.ico" alt="Interview Notes"><span class="site-name can-hide">Interview Notes</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/interview/" class="" aria-label="Home"><!--[--><!--]--> Home <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/lpdswing/interview" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><div id="docsearch-container"></div></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/interview/" class="" aria-label="Home"><!--[--><!--]--> Home <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/lpdswing/interview" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">Socket <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/interview/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/Socket.html#一、i-o-模型" class="router-link-active router-link-exact-active sidebar-item" aria-label="一、I/O 模型"><!--[--><!--]--> 一、I/O 模型 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/interview/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/Socket.html#阻塞式-i-o" class="router-link-active router-link-exact-active sidebar-item" aria-label="阻塞式 I/O"><!--[--><!--]--> 阻塞式 I/O <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/interview/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/Socket.html#非阻塞式-i-o" class="router-link-active router-link-exact-active sidebar-item" aria-label="非阻塞式 I/O"><!--[--><!--]--> 非阻塞式 I/O <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/interview/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/Socket.html#i-o-复用" class="router-link-active router-link-exact-active sidebar-item" aria-label="I/O 复用"><!--[--><!--]--> I/O 复用 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/interview/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/Socket.html#信号驱动-i-o" class="router-link-active router-link-exact-active sidebar-item" aria-label="信号驱动 I/O"><!--[--><!--]--> 信号驱动 I/O <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/interview/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/Socket.html#异步-i-o" class="router-link-active router-link-exact-active sidebar-item" aria-label="异步 I/O"><!--[--><!--]--> 异步 I/O <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/interview/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/Socket.html#五大-i-o-模型比较" class="router-link-active router-link-exact-active sidebar-item" aria-label="五大 I/O 模型比较"><!--[--><!--]--> 五大 I/O 模型比较 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/interview/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/Socket.html#二、i-o-复用" class="router-link-active router-link-exact-active sidebar-item" aria-label="二、I/O 复用"><!--[--><!--]--> 二、I/O 复用 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/interview/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/Socket.html#select" class="router-link-active router-link-exact-active sidebar-item" aria-label="select"><!--[--><!--]--> select <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/interview/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/Socket.html#poll" class="router-link-active router-link-exact-active sidebar-item" aria-label="poll"><!--[--><!--]--> poll <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/interview/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/Socket.html#比较" class="router-link-active router-link-exact-active sidebar-item" aria-label="比较"><!--[--><!--]--> 比较 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/interview/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/Socket.html#epoll" class="router-link-active router-link-exact-active sidebar-item" aria-label="epoll"><!--[--><!--]--> epoll <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/interview/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/Socket.html#工作模式" class="router-link-active router-link-exact-active sidebar-item" aria-label="工作模式"><!--[--><!--]--> 工作模式 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/interview/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/Socket.html#应用场景" class="router-link-active router-link-exact-active sidebar-item" aria-label="应用场景"><!--[--><!--]--> 应用场景 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/interview/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/Socket.html#参考资料" class="router-link-active router-link-exact-active sidebar-item" aria-label="参考资料"><!--[--><!--]--> 参考资料 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="socket" tabindex="-1"><a class="header-anchor" href="#socket" aria-hidden="true">#</a> Socket</h1><!-- GFM-TOC --><ul><li><a href="#socket">Socket</a><ul><li><a href="#%E4%B8%80io-%E6%A8%A1%E5%9E%8B">一、I/O 模型</a><ul><li><a href="#%E9%98%BB%E5%A1%9E%E5%BC%8F-io">阻塞式 I/O</a></li><li><a href="#%E9%9D%9E%E9%98%BB%E5%A1%9E%E5%BC%8F-io">非阻塞式 I/O</a></li><li><a href="#io-%E5%A4%8D%E7%94%A8">I/O 复用</a></li><li><a href="#%E4%BF%A1%E5%8F%B7%E9%A9%B1%E5%8A%A8-io">信号驱动 I/O</a></li><li><a href="#%E5%BC%82%E6%AD%A5-io">异步 I/O</a></li><li><a href="#%E4%BA%94%E5%A4%A7-io-%E6%A8%A1%E5%9E%8B%E6%AF%94%E8%BE%83">五大 I/O 模型比较</a></li></ul></li><li><a href="#%E4%BA%8Cio-%E5%A4%8D%E7%94%A8">二、I/O 复用</a><ul><li><a href="#select">select</a></li><li><a href="#poll">poll</a></li><li><a href="#%E6%AF%94%E8%BE%83">比较</a></li><li><a href="#epoll">epoll</a></li><li><a href="#%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F">工作模式</a></li><li><a href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF">应用场景</a></li></ul></li><li><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">参考资料</a></li></ul></li></ul><!-- GFM-TOC --><h2 id="一、i-o-模型" tabindex="-1"><a class="header-anchor" href="#一、i-o-模型" aria-hidden="true">#</a> 一、I/O 模型</h2><p>一个输入操作通常包括两个阶段：</p><ul><li>等待数据准备好</li><li>从内核向进程复制数据</li></ul><p>对于一个套接字上的输入操作，第一步通常涉及等待数据从网络中到达。当所等待数据到达时，它被复制到内核中的某个缓冲区。第二步就是把数据从内核缓冲区复制到应用进程缓冲区。</p><p>Unix 有五种 I/O 模型：</p><ul><li>阻塞式 I/O</li><li>非阻塞式 I/O</li><li>I/O 复用（select 和 poll）</li><li>信号驱动式 I/O（SIGIO）</li><li>异步 I/O（AIO）</li></ul><h3 id="阻塞式-i-o" tabindex="-1"><a class="header-anchor" href="#阻塞式-i-o" aria-hidden="true">#</a> 阻塞式 I/O</h3><p>应用进程被阻塞，直到数据从内核缓冲区复制到应用进程缓冲区中才返回。</p><p>应该注意到，在阻塞的过程中，其它应用进程还可以执行，因此阻塞不意味着整个操作系统都被阻塞。因为其它应用进程还可以执行，所以不消耗 CPU 时间，这种模型的 CPU 利用率会比较高。</p><p>下图中，recvfrom() 用于接收 Socket 传来的数据，并复制到应用进程的缓冲区 buf 中。这里把 recvfrom() 当成系统调用。</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token class-name">ssize_t</span> <span class="token function">recvfrom</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>src_addr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> <span class="token operator">*</span>addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div align="center"><img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/1492928416812_4.png"></div><br><h3 id="非阻塞式-i-o" tabindex="-1"><a class="header-anchor" href="#非阻塞式-i-o" aria-hidden="true">#</a> 非阻塞式 I/O</h3><p>应用进程执行系统调用之后，内核返回一个错误码。应用进程可以继续执行，但是需要不断的执行系统调用来获知 I/O 是否完成，这种方式称为轮询（polling）。</p><p>由于 CPU 要处理更多的系统调用，因此这种模型的 CPU 利用率比较低。</p><div align="center"><img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/1492929000361_5.png"></div><br><h3 id="i-o-复用" tabindex="-1"><a class="header-anchor" href="#i-o-复用" aria-hidden="true">#</a> I/O 复用</h3><p>使用 select 或者 poll 等待数据，并且可以等待多个套接字中的任何一个变为可读。这一过程会被阻塞，当某一个套接字可读时返回，之后再使用 recvfrom 把数据从内核复制到进程中。</p><p>它可以让单个进程具有处理多个 I/O 事件的能力。又被称为 Event Driven I/O，即事件驱动 I/O。</p><p>如果一个 Web 服务器没有 I/O 复用，那么每一个 Socket 连接都需要创建一个线程去处理。如果同时有几万个连接，那么就需要创建相同数量的线程。相比于多进程和多线程技术，I/O 复用不需要进程线程创建和切换的开销，系统开销更小。</p><div align="center"><img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/1492929444818_6.png"></div><br><h3 id="信号驱动-i-o" tabindex="-1"><a class="header-anchor" href="#信号驱动-i-o" aria-hidden="true">#</a> 信号驱动 I/O</h3><p>应用进程使用 sigaction 系统调用，内核立即返回，应用进程可以继续执行，也就是说等待数据阶段应用进程是非阻塞的。内核在数据到达时向应用进程发送 SIGIO 信号，应用进程收到之后在信号处理程序中调用 recvfrom 将数据从内核复制到应用进程中。</p><p>相比于非阻塞式 I/O 的轮询方式，信号驱动 I/O 的 CPU 利用率更高。</p><div align="center"><img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/1492929553651_7.png"></div><br><h3 id="异步-i-o" tabindex="-1"><a class="header-anchor" href="#异步-i-o" aria-hidden="true">#</a> 异步 I/O</h3><p>应用进程执行 aio_read 系统调用会立即返回，应用进程可以继续执行，不会被阻塞，内核会在所有操作完成之后向应用进程发送信号。</p><p>异步 I/O 与信号驱动 I/O 的区别在于，异步 I/O 的信号是通知应用进程 I/O 完成，而信号驱动 I/O 的信号是通知应用进程可以开始 I/O。</p><div align="center"><img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/1492930243286_8.png"></div><br><h3 id="五大-i-o-模型比较" tabindex="-1"><a class="header-anchor" href="#五大-i-o-模型比较" aria-hidden="true">#</a> 五大 I/O 模型比较</h3><ul><li>同步 I/O：将数据从内核缓冲区复制到应用进程缓冲区的阶段（第二阶段），应用进程会阻塞。</li><li>异步 I/O：第二阶段应用进程不会阻塞。</li></ul><p>同步 I/O 包括阻塞式 I/O、非阻塞式 I/O、I/O 复用和信号驱动 I/O ，它们的主要区别在第一个阶段。</p><p>非阻塞式 I/O 、信号驱动 I/O 和异步 I/O 在第一阶段不会阻塞。</p><div align="center"><img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/1492928105791_3.png"></div><br><h2 id="二、i-o-复用" tabindex="-1"><a class="header-anchor" href="#二、i-o-复用" aria-hidden="true">#</a> 二、I/O 复用</h2><p>select/poll/epoll 都是 I/O 多路复用的具体实现，select 出现的最早，之后是 poll，再是 epoll。</p><h3 id="select" tabindex="-1"><a class="header-anchor" href="#select" aria-hidden="true">#</a> select</h3><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>readfds<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>writefds<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>exceptfds<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">timeval</span> <span class="token operator">*</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>select 允许应用程序监视一组文件描述符，等待一个或者多个描述符成为就绪状态，从而完成 I/O 操作。</p><ul><li><p>fd_set 使用数组实现，数组大小使用 FD_SETSIZE 定义，所以只能监听少于 FD_SETSIZE 数量的描述符。有三种类型的描述符类型：readset、writeset、exceptset，分别对应读、写、异常条件的描述符集合。</p></li><li><p>timeout 为超时参数，调用 select 会一直阻塞直到有描述符的事件到达或者等待的时间超过 timeout。</p></li><li><p>成功调用返回结果大于 0，出错返回结果为 -1，超时返回结果为 0。</p></li></ul><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>fd_set fd_in<span class="token punctuation">,</span> fd_out<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">timeval</span> tv<span class="token punctuation">;</span>

<span class="token comment">// Reset the sets</span>
<span class="token function">FD_ZERO</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>fd_in <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">FD_ZERO</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>fd_out <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Monitor sock1 for input events</span>
<span class="token function">FD_SET</span><span class="token punctuation">(</span> sock1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fd_in <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Monitor sock2 for output events</span>
<span class="token function">FD_SET</span><span class="token punctuation">(</span> sock2<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fd_out <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Find out which socket has the largest numeric value as select requires it</span>
<span class="token keyword">int</span> largest_sock <span class="token operator">=</span> sock1 <span class="token operator">&gt;</span> sock2 <span class="token operator">?</span> sock1 <span class="token operator">:</span> sock2<span class="token punctuation">;</span>

<span class="token comment">// Wait up to 10 seconds</span>
tv<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
tv<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">// Call the select</span>
<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span> largest_sock <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fd_in<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fd_out<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>tv <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Check if select actually succeed</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>
    <span class="token comment">// report error and abort</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> ret <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span>
    <span class="token comment">// timeout; no event detected</span>
<span class="token keyword">else</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">FD_ISSET</span><span class="token punctuation">(</span> sock1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fd_in <span class="token punctuation">)</span> <span class="token punctuation">)</span>
        <span class="token comment">// input event on sock1</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">FD_ISSET</span><span class="token punctuation">(</span> sock2<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fd_out <span class="token punctuation">)</span> <span class="token punctuation">)</span>
        <span class="token comment">// output event on sock2</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="poll" tabindex="-1"><a class="header-anchor" href="#poll" aria-hidden="true">#</a> poll</h3><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pollfd</span> <span class="token operator">*</span>fds<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nfds<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>poll 的功能与 select 类似，也是等待一组描述符中的一个成为就绪状态。</p><p>poll 中的描述符是 pollfd 类型的数组，pollfd 的定义如下：</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">pollfd</span> <span class="token punctuation">{</span>
               <span class="token keyword">int</span>   fd<span class="token punctuation">;</span>         <span class="token comment">/* file descriptor */</span>
               <span class="token keyword">short</span> events<span class="token punctuation">;</span>     <span class="token comment">/* requested events */</span>
               <span class="token keyword">short</span> revents<span class="token punctuation">;</span>    <span class="token comment">/* returned events */</span>
           <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// The structure for two events</span>
<span class="token keyword">struct</span> <span class="token class-name">pollfd</span> fds<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// Monitor sock1 for input</span>
fds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> sock1<span class="token punctuation">;</span>
fds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">=</span> POLLIN<span class="token punctuation">;</span>

<span class="token comment">// Monitor sock2 for output</span>
fds<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> sock2<span class="token punctuation">;</span>
fds<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">=</span> POLLOUT<span class="token punctuation">;</span>

<span class="token comment">// Wait 10 seconds</span>
<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">poll</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>fds<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">10000</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Check if poll actually succeed</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>
    <span class="token comment">// report error and abort</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> ret <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span>
    <span class="token comment">// timeout; no event detected</span>
<span class="token keyword">else</span>
<span class="token punctuation">{</span>
    <span class="token comment">// If we detect the event, zero it out so we can reuse the structure</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> fds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLIN <span class="token punctuation">)</span>
        fds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">// input event on sock1</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> fds<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLOUT <span class="token punctuation">)</span>
        fds<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">// output event on sock2</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="比较" tabindex="-1"><a class="header-anchor" href="#比较" aria-hidden="true">#</a> 比较</h3><h4 id="_1-功能" tabindex="-1"><a class="header-anchor" href="#_1-功能" aria-hidden="true">#</a> 1. 功能</h4><p>select 和 poll 的功能基本相同，不过在一些实现细节上有所不同。</p><ul><li>select 会修改描述符，而 poll 不会；</li><li>select 的描述符类型使用数组实现，FD_SETSIZE 大小默认为 1024，因此默认只能监听少于 1024 个描述符。如果要监听更多描述符的话，需要修改 FD_SETSIZE 之后重新编译；而 poll 没有描述符数量的限制；</li><li>poll 提供了更多的事件类型，并且对描述符的重复利用上比 select 高。</li><li>如果一个线程对某个描述符调用了 select 或者 poll，另一个线程关闭了该描述符，会导致调用结果不确定。</li></ul><h4 id="_2-速度" tabindex="-1"><a class="header-anchor" href="#_2-速度" aria-hidden="true">#</a> 2. 速度</h4><p>select 和 poll 速度都比较慢，每次调用都需要将全部描述符从应用进程缓冲区复制到内核缓冲区。</p><h4 id="_3-可移植性" tabindex="-1"><a class="header-anchor" href="#_3-可移植性" aria-hidden="true">#</a> 3. 可移植性</h4><p>几乎所有的系统都支持 select，但是只有比较新的系统支持 poll。</p><h3 id="epoll" tabindex="-1"><a class="header-anchor" href="#epoll" aria-hidden="true">#</a> epoll</h3><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">epoll_ctl</span><span class="token punctuation">(</span><span class="token keyword">int</span> epfd<span class="token punctuation">,</span> <span class="token keyword">int</span> op<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token operator">*</span>event<span class="token punctuation">)</span>；
<span class="token keyword">int</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span><span class="token keyword">int</span> epfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token operator">*</span> events<span class="token punctuation">,</span> <span class="token keyword">int</span> maxevents<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>epoll_ctl() 用于向内核注册新的描述符或者是改变某个文件描述符的状态。已注册的描述符在内核中会被维护在一棵红黑树上，通过回调函数内核会将 I/O 准备好的描述符加入到一个链表中管理，进程调用 epoll_wait() 便可以得到事件完成的描述符。</p><p>从上面的描述可以看出，epoll 只需要将描述符从进程缓冲区向内核缓冲区拷贝一次，并且进程不需要通过轮询来获得事件完成的描述符。</p><p>epoll 仅适用于 Linux OS。</p><p>epoll 比 select 和 poll 更加灵活而且没有描述符数量限制。</p><p>epoll 对多线程编程更有友好，一个线程调用了 epoll_wait() 另一个线程关闭了同一个描述符也不会产生像 select 和 poll 的不确定情况。</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// Create the epoll descriptor. Only one is needed per app, and is used to monitor all sockets.</span>
<span class="token comment">// The function argument is ignored (it was not before, but now it is), so put your favorite number here</span>
<span class="token keyword">int</span> pollingfd <span class="token operator">=</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span> <span class="token number">0xCAFE</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> pollingfd <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span>
 <span class="token comment">// report error</span>

<span class="token comment">// Initialize the epoll structure in case more members are added in future</span>
<span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> ev <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Associate the connection class instance with the event. You can associate anything</span>
<span class="token comment">// you want, epoll does not use this information. We store a connection class pointer, pConnection1</span>
ev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr <span class="token operator">=</span> pConnection1<span class="token punctuation">;</span>

<span class="token comment">// Monitor for input, and do not automatically rearm the descriptor after the event</span>
ev<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN <span class="token operator">|</span> EPOLLONESHOT<span class="token punctuation">;</span>
<span class="token comment">// Add the descriptor into the monitoring list. We can do it even if another thread is</span>
<span class="token comment">// waiting in epoll_wait - the descriptor will be properly added</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">epoll_ctl</span><span class="token punctuation">(</span> epollfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> pConnection1<span class="token operator">-&gt;</span><span class="token function">getSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ev <span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span>
    <span class="token comment">// report error</span>

<span class="token comment">// Wait for up to 20 events (assuming we have added maybe 200 sockets before that it may happen)</span>
<span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> pevents<span class="token punctuation">[</span> <span class="token number">20</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// Wait for 10 seconds, and retrieve less than 20 epoll_event and store them into epoll_event array</span>
<span class="token keyword">int</span> ready <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span> pollingfd<span class="token punctuation">,</span> pevents<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">10000</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Check if epoll actually succeed</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>
    <span class="token comment">// report error and abort</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> ret <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span>
    <span class="token comment">// timeout; no event detected</span>
<span class="token keyword">else</span>
<span class="token punctuation">{</span>
    <span class="token comment">// Check if any events detected</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ready<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> pevents<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// Get back our connection pointer</span>
            Connection <span class="token operator">*</span> c <span class="token operator">=</span> <span class="token punctuation">(</span>Connection<span class="token operator">*</span><span class="token punctuation">)</span> pevents<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">;</span>
            c<span class="token operator">-&gt;</span><span class="token function">handleReadEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="工作模式" tabindex="-1"><a class="header-anchor" href="#工作模式" aria-hidden="true">#</a> 工作模式</h3><p>epoll 的描述符事件有两种触发模式：LT（level trigger）和 ET（edge trigger）。</p><h4 id="_1-lt-模式" tabindex="-1"><a class="header-anchor" href="#_1-lt-模式" aria-hidden="true">#</a> 1. LT 模式</h4><p>当 epoll_wait() 检测到描述符事件到达时，将此事件通知进程，进程可以不立即处理该事件，下次调用 epoll_wait() 会再次通知进程。是默认的一种模式，并且同时支持 Blocking 和 No-Blocking。</p><h4 id="_2-et-模式" tabindex="-1"><a class="header-anchor" href="#_2-et-模式" aria-hidden="true">#</a> 2. ET 模式</h4><p>和 LT 模式不同的是，通知之后进程必须立即处理事件，下次再调用 epoll_wait() 时不会再得到事件到达的通知。</p><p>很大程度上减少了 epoll 事件被重复触发的次数，因此效率要比 LT 模式高。只支持 No-Blocking，以避免由于一个文件句柄的阻塞读/阻塞写操作把处理多个文件描述符的任务饿死。</p><h3 id="应用场景" tabindex="-1"><a class="header-anchor" href="#应用场景" aria-hidden="true">#</a> 应用场景</h3><p>很容易产生一种错觉认为只要用 epoll 就可以了，select 和 poll 都已经过时了，其实它们都有各自的使用场景。</p><h4 id="_1-select-应用场景" tabindex="-1"><a class="header-anchor" href="#_1-select-应用场景" aria-hidden="true">#</a> 1. select 应用场景</h4><p>select 的 timeout 参数精度为微秒，而 poll 和 epoll 为毫秒，因此 select 更加适用于实时性要求比较高的场景，比如核反应堆的控制。</p><p>select 可移植性更好，几乎被所有主流平台所支持。</p><h4 id="_2-poll-应用场景" tabindex="-1"><a class="header-anchor" href="#_2-poll-应用场景" aria-hidden="true">#</a> 2. poll 应用场景</h4><p>poll 没有最大描述符数量的限制，如果平台支持并且对实时性要求不高，应该使用 poll 而不是 select。</p><h4 id="_3-epoll-应用场景" tabindex="-1"><a class="header-anchor" href="#_3-epoll-应用场景" aria-hidden="true">#</a> 3. epoll 应用场景</h4><p>只需要运行在 Linux 平台上，有大量的描述符需要同时轮询，并且这些连接最好是长连接。</p><p>需要同时监控小于 1000 个描述符，就没有必要使用 epoll，因为这个应用场景下并不能体现 epoll 的优势。</p><p>需要监控的描述符状态变化多，而且都是非常短暂的，也没有必要使用 epoll。因为 epoll 中的所有描述符都存储在内核中，造成每次需要对描述符的状态改变都需要通过 epoll_ctl() 进行系统调用，频繁系统调用降低效率。并且 epoll 的描述符存储在内核，不容易调试。</p><h2 id="参考资料" tabindex="-1"><a class="header-anchor" href="#参考资料" aria-hidden="true">#</a> 参考资料</h2><ul><li>Stevens W R, Fenner B, Rudoff A M. UNIX network programming[M]. Addison-Wesley Professional, 2004.</li><li>http://man7.org/linux/man-pages/man2/select.2.html</li><li>http://man7.org/linux/man-pages/man2/poll.2.html</li><li><a href="https://www.ibm.com/developerworks/linux/library/l-async/" target="_blank" rel="noopener noreferrer">Boost application performance using asynchronous I/O<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa365683(v=vs.85).aspx" target="_blank" rel="noopener noreferrer">Synchronous and Asynchronous I/O<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://segmentfault.com/a/1190000003063859" target="_blank" rel="noopener noreferrer">Linux IO 模式及 select、poll、epoll 详解<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://daniel.haxx.se/docs/poll-vs-select.html" target="_blank" rel="noopener noreferrer">poll vs select vs event-based<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="http://www.ulduzsoft.com/2014/01/select-poll-epoll-practical-difference-for-system-architects/" target="_blank" rel="noopener noreferrer">select / poll / epoll: practical difference for system architects<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://code.woboq.org/userspace/glibc/sysdeps/unix/sysv/linux/" target="_blank" rel="noopener noreferrer">Browse the source code of userspace/glibc/sysdeps/unix/sysv/linux/ online<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul></div><!--[--><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: lpdswing@qq.com">lpdswing</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/interview/assets/app.5177f3e3.js" defer></script>
  </body>
</html>
